# CentOS 6.x Minimal Installation & Configuration

## 启动网卡  
CentOS 6.x最小化安装后，网卡默认不是启动状态
```
ifup eth0
```

## 安装SSH客户端
```
yum -y install openssh-clients
```

## 配置网络  
**网卡配置**  
备份`ifcfg-eth0`配置文件
```
mv /etc/sysconfig/network-scripts/ifcfg-eth0 /etc/sysconfig/network-scripts/ifcfg-eth0.backup
```
按如下示例编辑网络配置文件
```
vi /etc/sysconfig/network-scripts/ifcfg-eth0

# 网卡设备名称
DEVICE=eth0
# 以太网设备的对应的物理地址
HWADDR=00:0C:29:C5:44:01
# 网络类型为以太网模式
TYPE=Ethernet
# 通用唯一识别码
UUID=20b82495-869f-4938-8f8f-e7481e4e91b8
# 是否启动引导的时候激活YES
ONBOOT=yes
# 设备eth0是否可以由Network Manager图形管理工具托管
NM_CONTROLLED=yes
# 静态IP地址获取状态 ：DHCP表示自动获取IP地址、static表示静态IP
BOOTPROTO=static
# 静态IP
IPADDR=192.168.70.210
# 网卡对应的子网掩码
NETMASK=255.255.255.0
# 网关地址
GATEWAY=192.168.70.1
IPV6INIT=no
USERCTL=no
```
**网关配置**
```
vi /etc/sysconfig/network

# 表示系统是否使用网络，一般设置为yes。如果设为no，则不能使用网络，而且很多系统服务程序将无法启动
NETWORKING=yes
# 设置本机的主机名，这里设置的主机名要和/etc/hosts中设置的主机名对应
HOSTNAME=zlikun.localdomain
# 设置本机连接的网关的IP地址。例如，网关为10.0.0.0.1或者192.168.1.1
GATEWAY=192.168.1.1
```
**修改主机DNS**
```
vi /etc/resolv.conf

; generated by /sbin/dhclient-script
nameserver 8.8.8.8
nameserver 4.4.4.4
```
**修改HOSTS**
```
vi /etc/hosts

127.0.0.1 zlikun.localdomain
# 使用DNS域名服务器来解析名字
order bind hosts
# 一台主机是否存在多个IP
multi on
# 如果用逆向解析找出与指定的地址匹配的主机名，对返回的地址进行解析以确认它确实与您查询的地址相配。为了防止“骗取”IP地址
nospoof on
```
**重启网卡生效设置两种方法**
```
service network restart
```
或
```
/etc/init.d/network restart
```

## 安装`wget`工具  
必须先安装在修改源(用于修改源时需要下载相应文件)  

## 修改源  
**备份原系统更新源**
```
mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup
```
进入yum.repos.d目录
```
cd /etc/yum.repos.d
```
下载网易镜像源
```
wget http://mirrors.163.com/.help/CentOS6-Base-163.repo
```
或下载搜狐镜像源
```
wget http://mirrors.sohu.com/help/CentOS-Base-sohu.repo
```
**注：**网易搜狐的源可能有问题，参考：<http://blog.csdn.net/ichsonx/article/details/8518420>

**修改源**
```
# 清空yum缓存
yum clean all
# 生存缓存
yum makecache
# 开始更新系统以及内核
yum upgrade
```

## 更新系统时间  
**安装更新时间必备软件**
```
yum install -y ntpdate
```
**更新时间并且写入BIOS**
```
ntpdate time.windows.com && hwclock -w && hwclock --systohc
```
还有其它操作，参考：<http://www.lvtao.net/server/centos-server-setup.html>  

##  selinux与iptables
**查看selinux状态(四种方法)**
* /usr/bin/setstatus -v # 如果显示：SELinux status: enabled 就是开启状态
* cat /etc/selinux/config # 如果显示：SELINUX=enforcing 则是开启状态，permissive有提醒的状态，disabled是关闭状态
* grep SELINUX=disabled /etc/selinux/config
* getenforce
**修改selinux状态(如果修改配置文件则永久生效，但是必须要重启系统)**
* vi /etc/selinux/config 修改 SELINUX=disabled
* sed –i 's/SELINUX=enforcing/SELINUX=disabled/g' /etc/selinux/config
**如果想立即生效(如果想临时性的改变)**
setenforce 1 # 设置SELinux 成为enforcing模式
setenforce 0 # 设置SELinux 成为permissive模式
getenforce # 查看状态

**iptables防火墙规则清理了，根据需求定制**
```
# 清空iptables规则
iptables -F
# 查看iptables规则
iptables -L
# 保存规则，注意，虽然清空了，不保存的话，重启后，又会有规则
/etc/init.d/iptables save
```

## 创建普通用户并进行sudo授权管理  
**创建普通用户**
```
useradd likun
```
**修改用户密码**
```
passwd likun
```
按照提示输入密码即可

**也可以一次性创建用户和设置密码**
```
echo "123456"|passwd --stdin likun&&history –c
```
其中`likun`是用户名

sudo授权管理
```
visudo

# 找到99行，在下面添加
likun ALL=(ALL) ALL
```

## 修改SSH端口号和屏蔽root账号远程登陆
```
# 备份SSH配置 
cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup
# 修改SSH安全配置 
vi /etc/ssh/sshd_config
# SSH链接默认端口
port 52113
# 禁止root账号登陆
PermitRootLogin no
# 禁止空密码
PermitEmptyPasswords no
# 不使用DNS
UseDNS no
```
重新载入SSH配置`/etc/init.d/sshd reload`，查看端口里面是否有刚才修改过的端口号`52113`
```
netstat -lnt
```
或者反查端口是那个进程
```
lsof -i tcp:52113
```
CentOS 6.x最小化安装没有`lsof`工具需要`yum install lsof`

## 锁定关键文件系统（禁止非授权用户获得权限）
```
chattr +i /etc/passwd
chattr +i /etc/inittab
chattr +i /etc/group
chattr +i /etc/shadow
chattr +i /etc/gshadow
```

## 精简开机自启动服务
**注意:** 刚装完操作系统一般可以只保留crond，network，syslog，sshd这四个服务。 后期根据业务需求制定自启服务 #（Centos6.x为`rsyslog` Cetnos5.x为`syslog`） 如果是中文的话，可能会需要LANG=en 或者替换`3:on`成`3:启用`
```
# 关闭全部服务
for sun in `chkconfig --list|grep 3:on|awk '{print $1}'`;do chkconfig --level 3 $sun off;done
# 或者
for sun in `chkconfig --list|grep 3:启用|awk '{print $1}'`;do chkconfig --level 3 $sun off;done
# 开启需要的服务
for sun in crond rsyslog sshd network;do chkconfig --level 3 $sun on;done
# 或者需要使用防火墙的话可以开启iptables和ip6tables
for sun in crond rsyslog sshd network iptables ip6tables;do chkconfig --level 3 $sun on;done
```
查询下开启的服务`chkconfig –list | grep 3:on`或者`chkconfig –list|grep 3:启用`
```
$ chkconfig --list|grep 3:on
crond           0:关闭    1:关闭    2:启用    3:启用    4:启用    5:启用    6:关闭
ip6tables       0:关闭    1:关闭    2:启用    3:启用    4:启用    5:启用    6:关闭
iptables        0:关闭    1:关闭    2:启用    3:启用    4:启用    5:启用    6:关闭
network         0:关闭    1:关闭    2:启用    3:启用    4:启用    5:启用    6:关闭
rsyslog         0:关闭    1:关闭    2:启用    3:启用    4:启用    5:启用    6:关闭
sshd            0:关闭    1:关闭    2:启用    3:启用    4:启用    5:启用    6:关闭
```

## 调整文件描述符大小
**查看文件描述符大小**
```
ulimit -n 
```
**下面有四种调整方式**

* 这里参考的是阿里云主机默认设置
```
vi /etc/security/limits.conf 
* soft nofile 65535 
* hard nofile 65535 
* soft nproc 65535 
* hard nproc 65535 
* soft nofile 65535
* hard nofile 65535 
```
* >>
```
echo '* - nofile 65535' >> /etc/security/limits.conf
```
* 把ulimit -SHn 65535命令加入到/etc/rc.local，然后每次重启生效 追加命令到rc.local配置文件里面
```
cat >>/etc/rc.local<<EOF
#open files
ulimit -HSn 65535
#stack size
ulimit -s 65535
EOF
```
* 如果不修改limits配置文件，直接立即生效，但重启后又恢复之前的默认。
```
ulimit -SHn 65535
```

## 设置系统字符集
`vi /etc/sysconfig/i18n`
中文提示：`LANG="zh_CN.UTF-8"`，英文提示：`LANG="en_US.UTF-8"`，如果临时切换也可以直接执行： `LANG=zh_CN.UTF-8`

或者使用sed快速替换
```
# 替换成英文
sed -i 's#LANG="zh_CN.*"#LANG="en_US.UTF-8"#' /etc/sysconfig/i18n
# 替换成中文
sed -i 's#LANG="en_US.*"#LANG="zh_CN.UTF-8"#' /etc/sysconfig/i18n
# 替换成UTF-8中文
sed -i 's#LANG="zh_CN.*"#LANG="zh_CN.UTF-8"#' /etc/sysconfig/i18n
```

## 清理登陆的时候显示的系统及内核版本
```
# 查看登陆信息 
cat /etc/redhat-release cat /etc/issue 
# 清理登陆信息
echo >/etc/redhat-release 
echo >/etc/issue
```

## 内核参数优化`vi /etc/sysctl.conf`
```
# 可用于apache，nginx，squid多种等web应用
net.ipv4.tcp_max_syn_backlog = 65536
net.core.netdev_max_backlog = 32768
net.core.somaxconn = 32768

net.core.wmem_default = 8388608
net.core.rmem_default = 8388608
net.core.rmem_max = 16777216
net.core.wmem_max = 16777216

net.ipv4.tcp_timestamps = 0
net.ipv4.tcp_synack_retries = 2
net.ipv4.tcp_syn_retries = 2

net.ipv4.tcp_tw_recycle = 1
#net.ipv4.tcp_tw_len = 1
net.ipv4.tcp_tw_reuse = 1

net.ipv4.tcp_mem = 94500000 915000000 927000000
net.ipv4.tcp_max_orphans = 3276800

#net.ipv4.tcp_fin_timeout = 30
#net.ipv4.tcp_keepalive_time = 120
net.ipv4.ip_local_port_range = 1024 65535

# 以下参数是对centos6.x的iptables防火墙的优化，防火墙不开会有提示，可以忽略不理。
# 如果是centos5.X需要吧netfilter.nf_conntrack替换成ipv4.netfilter.ip
# centos5.X为net.ipv4.ip_conntrack_max = 25000000
net.nf_conntrack_max = 25000000
net.netfilter.nf_conntrack_max = 25000000
net.netfilter.nf_conntrack_tcp_timeout_established = 180
net.netfilter.nf_conntrack_tcp_timeout_time_wait = 120
net.netfilter.nf_conntrack_tcp_timeout_close_wait = 60
net.netfilter.nf_conntrack_tcp_timeout_fin_wait = 120
```
立即生效 /sbin/sysctl -p centos6.5可能会报错
```
error: "net.bridge.bridge-nf-call-ip6tables" is an unknown key
error: "net.bridge.bridge-nf-call-iptables" is an unknown key
error: "net.bridge.bridge-nf-call-arptables" is an unknown key
```
出现这个的原因是，没有自动载入bridge桥接模块
```
modprobe bridge
echo "modprobe bridge">> /etc/rc.local
```
查看桥接 lsmod|grep bridge
centos5.X可能会报错 这个错误可能是你的防火墙没有开启或者自动处理可载入的模块ip_conntrack没有自动载入，解决办法有二，一是开启防火墙，二是自动处理开载入的模块ip_conntrack
```
error: "net.ipv4.ip_conntrack_max"is an unknown key
error: "net.ipv4.netfilter.ip_conntrack_max"is an unknown key
error: "net.ipv4.netfilter.ip_conntrack_tcp_timeout_established"is an unknown key
error: "net.ipv4.netfilter.ip_conntrack_tcp_timeout_time_wait"is an unknown key
error: "net.ipv4.netfilter.ip_conntrack_tcp_timeout_close_wait"is an unknown key
error: "net.ipv4.netfilter.ip_conntrack_tcp_timeout_fin_wait"is an unknown key
```
centos5.X解决方法：
```
modprobe ip_conntrack
echo "modprobe ip_conntrack">> /etc/rc.local
```
centos6.X可能会报错 这个错误可能是你的防火墙没有开启或者自动处理可载入的模块ip_conntrack没有自动载入，解决办法有二，一是开启防火墙，二是自动处理开载入的模块ip_conntrack
```
error: "net.nf_conntrack_max"isan unknown key
error: "net.netfilter.nf_conntrack_max"isan unknown key
error: "net.netfilter.nf_conntrack_tcp_timeout_established"isan unknown key
error: "net.netfilter.nf_conntrack_tcp_timeout_time_wait"isan unknown key
error: "net.netfilter.nf_conntrack_tcp_timeout_close_wait"isan unknown key
error: "net.netfilter.nf_conntrack_tcp_timeout_fin_wait"isan unknown key
```
centos6.X解决方法：
```
modprobe nf_conntrack
echo "modprobe nf_conntrack">> /etc/rc.local
```
注意：笔者在整理这篇centos6.5内核优化的时候发现，如果不开启ip6tables去优化nf_conntrack模块去执行上面的解决方法会依旧提示上面的error。所以在优化服务的时候，可以选择留下iptables和ip6tables。当然如果不用iptables的话，在内核优化的时候就要去掉对nf_conntrack的设置，在进行/sbin/sysctl -p 是不会有错误提示的

## 如果安装sendmail必须定时自动清理`/var/spool/clientmqueue/`下文件防止inode节点被占满
```
# centos6.5已经不自动安装sendmail了所以没必要走这一步优化
mkdir -p /server/scripts
vi /server/scripts/spool_clean.sh

#!/bin/sh
find/var/spool/clientmqueue/-typef -mtime +30|xargsrm-f
```

## 删除不必要的系统用户和群组
```
# 删除不必要的用户
userdel adm
userdel lp
userdel sync
userdel shutdown
userdel halt
userdel news
userdel uucp
userdel operator
userdel games
userdel gopher
userdel ftp
# 删除不必要的群组
groupdel adm
groupdel lp
groupdel news
groupdel uucp
groupdel games
groupdel dip
groupdel pppusers
```

## 关闭重启`ctl-alt-delete`组合键
```
vi /etc/init/control-alt-delete.conf
# 注释掉
# exec /sbin/shutdown -r now "Control-Alt-Deletepressed" 
```

## 设置一些全局变量
```
# 设置自动退出终端，防止非法关闭ssh客户端造成登录进程过多，可以设置大一些，单位为秒
echo "TMOUT=3600">> /etc/profile
# 历史命令记录数量设置为10条
sed -i "s/HISTSIZE=1000/HISTSIZE=10/" /etc/profile
# 立即生效
source /etc/profile
```

原文来自：《[生产服务器环境最小化安装后 Centos 6.5优化配置备忘](http://www.lvtao.net/server/centos-server-setup.html)》
